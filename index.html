<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Estudio: Riesgos Bancarios (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        const appId = 'riesgos-bancarios-app-local-v3'; // Namespace for localStorage, v3 for new questions
        let preguntasGlobal = [];

        const TEMAS_NOMBRES = [
            "Tema 1: Fundamentos de Riesgos y Adecuación de Capital",
            "Tema 2: Gestión del Riesgo de Crédito: Particulares",
            "Tema 3: Análisis de Estados Financieros",
            "Tema 4: Gestión del Riesgo de Crédito: Empresas, Seguimiento y Morosidad",
            "Tema 5: Riesgos de Productos de Activo",
            "Tema 6: Concesión de Operaciones a Personas Físicas: Consumo/Hipotecario",
            "Tema 7: Concesión de Operaciones a Personas Físicas: Negocios",
            "Tema 8: Concesión de Operaciones a Personas Jurídicas: Microempresas",
            "Tema 9: Concesión de Operaciones al Sector Agrícola",
            "Tema 10: Formalización, Seguimiento, Morosidad y Acción Recuperadora"
        ];

        // Esta función ahora contendrá las preguntas extraídas de los documentos
        async function cargarPreguntas() {
            preguntasGlobal = [
                // --- INICIO DE PREGUNTAS EXTRAÍDAS ---

                // Test Wenceslao (Asumiendo que las primeras 20 son Tema 1, las siguientes 20 Tema 2, etc.)
                // Tema 1
                { id: "w_t1_p1", tema: 1, origen: "Wenceslao", texto: "De acuerdo al Pilar III de los acuerdos de Basilea, las entidades están obligadas a publicar un informe explicativo de las medidas aplicadas para la adecuación y evaluación interna de la liquidez, denominado:", opciones: [{ texto: "Informe de Liquidez.", esCorrecta: false }, { texto: "Informe del Pilar III.", esCorrecta: false }, { texto: "Informe de Relevancia Prudencial.", esCorrecta: true }, { texto: "Informe de Solvencia.", esCorrecta: false }] },
                { id: "w_t1_p2", tema: 1, origen: "Wenceslao", texto: "El riesgo ocasionado por prácticas inadecuadas en la relación del banco con sus clientes, el trato y los productos ofrecidos a los mismos y su adecuación a cada cliente concreto, se denomina:", opciones: [{ texto: "Riesgo modelo", esCorrecta: false }, { texto: "Riesgo reputacional", esCorrecta: false }, { texto: "Riesgo legal", esCorrecta: false }, { texto: "Riesgo de conducta", esCorrecta: true }] },
                { id: "w_t1_p3", tema: 1, origen: "Wenceslao", texto: "La pérdida o disminución de rentabilidad a consecuencias de modificaciones en el marco regulatorio por fallos judiciales desfavorables para la entidad se tipifica como:", opciones: [{ texto: "Riesgo Soberano.", esCorrecta: false }, { texto: "Riesgo de Conducta.", esCorrecta: false }, { texto: "Riesgo Legal y regulatorio.", esCorrecta: true }, { texto: "Riesgo Reputacional.", esCorrecta: false }] },
                { id: "w_t1_p4", tema: 1, origen: "Wenceslao", texto: "El principal objetivo, entre otros, de Cumplimiento Normativo es:", opciones: [{ texto: "Detectar posibles deficiencias en procedimientos que originen, actuaciones u omisiones no ajustadas al marco jurídico y regulatorio que puedan derivar en sanciones administrativas o daños reputacionales.", esCorrecta: true }, { texto: "Establecer la política de riesgos de la entidad.", esCorrecta: false }, { texto: "Redactar toda la normativa interna de la entidad, para mitigar los riesgos y evitar sanciones administrativas, creando un marco único para la toma de decisiones.", esCorrecta: false }, { texto: "Evaluar la eficacia y eficiencia de los Sistemas de Control Interno establecidos para la mitigación de riesgos, formular recomendaciones sobre debilidades.", esCorrecta: false }] },
                { id: "w_t1_p5", tema: 1, origen: "Wenceslao", texto: "Cuando un banco, a pesar de tener solvencia patrimonial, no puede atender el pago a su vencimiento de una emisión de títulos destinada a captar fondos, es un riesgo:", opciones: [{ texto: "Operacional.", esCorrecta: false }, { texto: "Crédito.", esCorrecta: false }, { texto: "Liquidez.", esCorrecta: true }, { texto: "Reputacional.", esCorrecta: false }] },
                { id: "w_t1_p6", tema: 1, origen: "Wenceslao", texto: "Cuando se observa que los resultados reales sobre el comportamiento de un determinado riesgo (mercado, divisas, crédito, etc.) difieren de los datos previstos, como consecuencia de una incorrecta definición de los parámetros, datos y/o métricas cuantitativas empleados en la hipótesis inicial, decimos que estamos incurriendo en un:", opciones: [{ texto: "Riesgo tecnológico.", esCorrecta: false }, { texto: "Riesgo conducta y cumplimento.", esCorrecta: false }, { texto: "Riesgo reputacional.", esCorrecta: false }, { texto: "Riesgo modelo.", esCorrecta: true }] },
                { id: "w_t1_p7", tema: 1, origen: "Wenceslao", texto: "En la formalización del marco del apetito de riesgo, se suelen fijar cuatro dimensiones prioritarias", opciones: [{ texto: "Cultura de riesgos, estrategia y líneas de defensa.", esCorrecta: false }, { texto: "Protección ante las perdidas, liquidez y financiación, composición del negocio, valor de la franquicia", esCorrecta: true }, { texto: "Estrategia, lenguaje común, marco de relación y límites máximos.", esCorrecta: false }, { texto: "Modelo de negocio, límites máximos, líneas de defensa.", esCorrecta: false }] },
                { id: "w_t1_p8", tema: 1, origen: "Wenceslao", texto: "El término ‘corralito’ se ha venido utilizando para representar de forma gráfica, la actuación de algunas entidades de crédito que han cerrado sus puertas, por no poder atender los pagos a sus clientes, cuando estas tienen un elevado riesgo de:", opciones: [{ texto: "Mercado.", esCorrecta: false }, { texto: "Interés.", esCorrecta: false }, { texto: "Liquidez.", esCorrecta: true }, { texto: "Operacional.", esCorrecta: false }] },
                { id: "w_t1_p9", tema: 1, origen: "Wenceslao", texto: "Un instrumento subordinado emitido por la entidad con un vencimiento de 7 años no asegurado por el emisor ¿puede computar como capital regulatorio?", opciones: [{ texto: "No, puesto que se trata de un producto híbrido.", esCorrecta: false }, { texto: "Sí, pero como capital adicional de nivel 1.", esCorrecta: false }, { texto: "Sí, pero como capital de nivel 3.", esCorrecta: false }, { texto: "Sí, pero como capital de nivel 2.", esCorrecta: true }] },
                { id: "w_t1_p10", tema: 1, origen: "Wenceslao", texto: "La ratio que propone que las entidades cubran sus necesidades permanentes de liquidez derivadas de la actividad comercial a través de una adecuada financiación, mediante instrumentos de medio y largo plazo, y de una limitada apelación al corto plazo, así como un mayor peso de los depósitos de clientes, se denomina:", opciones: [{ texto: "LtV (‘loan to value’).", esCorrecta: false }, { texto: "LRC (‘liquidity coverage ratio’).", esCorrecta: false }, { texto: "LtD (‘loan to deposit’).", esCorrecta: false }, { texto: "NSFR (‘net stable funding ratio’).", esCorrecta: true }] },
                { id: "w_t1_p11", tema: 1, origen: "Wenceslao", texto: "¿El ROE y el RAR de una operación son siempre coincidentes?", opciones: [{ texto: "Sí, porque ambas ratios parten del mismo margen financiero de la operación.", esCorrecta: false }, { texto: "No, porque el RAR incorpora de manera específica los riesgos que se asumen al efectuar la operación y el ROE no.", esCorrecta: true }, { texto: "No, porque una ratio mide la rentabilidad y la otra la probabilidad de impago.", esCorrecta: false }, { texto: "Sí, porque ambas ratios son indicadoras de rentabilidad.", esCorrecta: false }] },
                { id: "w_t1_p12", tema: 1, origen: "Wenceslao", texto: "La definición, actualización y supervisión del cumplimiento del marco de apetito al riesgo, es una responsabilidad del:", opciones: [{ texto: "Comité de Activos y Pasivos.", esCorrecta: false }, { texto: "Dirección General.", esCorrecta: false }, { texto: "Dirección de Riesgos.", esCorrecta: false }, { texto: "Consejo de Administración.", esCorrecta: true }] },
                { id: "w_t1_p13", tema: 1, origen: "Wenceslao", texto: "El Mecanismo Único de Supervisión (MUS) tiene por objetivo:", opciones: [{ texto: "Imponer los requisitos de absorción de pérdidas.", esCorrecta: false }, { texto: "Coordinar la actuación de los auditores internos de las entidades de la UEM.", esCorrecta: false }, { texto: "Mutualizar las pérdidas en los posibles rescates bancarios.", esCorrecta: false }, { texto: "Someter a las entidades significativas a la supervisión directa del BCE.", esCorrecta: true }] },
                { id: "w_t1_p14", tema: 1, origen: "Wenceslao", texto: "El riesgo de tipo de interés puede ser más acusado en una entidad, cuando:", opciones: [{ texto: "Suben los tipos de interés.", esCorrecta: false }, { texto: "Existe un GAP (brecha) importante ente los plazos residuales o de revaluación (tiempo hasta el vencimiento o revisión) de las operaciones de activo y las de captación de pasivo.", esCorrecta: true }, { texto: "Cuando bajan los tipos de interés.", esCorrecta: false }, { texto: "Cuando la oficina realiza captaciones o retenciones de pasivo, pagando un tipo de interés superior a la media.", esCorrecta: false }] },
                { id: "w_t1_p15", tema: 1, origen: "Wenceslao", texto: "En el marco de Basilea III, el capital de liquidación (‘gone-concern capital’) se corresponde con:", opciones: [{ texto: "El capital de nivel 1.", esCorrecta: false }, { texto: "El capital de nivel 2.", esCorrecta: true }, { texto: "El capital desembolsado.", esCorrecta: false }, { texto: "El colchón adicional de capital.", esCorrecta: false }] },
                { id: "w_t1_p16", tema: 1, origen: "Wenceslao", texto: "El riesgo de tipo de cambio:", opciones: [{ texto: "Es debido a la variación de las fluctuaciones de los tipos de interés en un determinado país o divisa.", esCorrecta: false }, { texto: "Es la pérdida que sufre la entidad al mantener posiciones de activos y pasivos denominados en divisas, por las variaciones de esta divisa.", esCorrecta: true }, { texto: "Son las pérdidas de valor que se producen en las operaciones de crédito por el impago de sus clientes.", esCorrecta: false }, { texto: "Es un quebranto que se produce al aplicar un cambio de cotización erróneo en una operación de compra o venta de divisas.", esCorrecta: false }] },
                { id: "w_t1_p17", tema: 1, origen: "Wenceslao", texto: "Dentro del modelo piramidal del marco del apetito de riesgo que tiene establecido la entidad, las áreas gestoras/controladoras de riesgo, pertenecen al:", opciones: [{ texto: "Ningún nivel.", esCorrecta: false }, { texto: "Nivel 1.", esCorrecta: false }, { texto: "Nivel 2.", esCorrecta: false }, { texto: "Nivel 3.", esCorrecta: true }] },
                { id: "w_t1_p18", tema: 1, origen: "Wenceslao", texto: "La creación de valor de una operación o cliente se define como:", opciones: [{ texto: "El margen que se obtiene una vez retribuido el coste de capital empleado.", esCorrecta: true }, { texto: "El potencial comercial que tiene el cliente para nuevas operaciones.", esCorrecta: false }, { texto: "El margen que se obtiene una vez descontada la pérdida esperada.", esCorrecta: false }, { texto: "El exceso de garantías sobre el nominal de la operación.", esCorrecta: false }] },
                { id: "w_t1_p19", tema: 1, origen: "Wenceslao", texto: "La ratio de apalancamiento (‘leverage ratio’), prevista en Basilea III se define como el cociente entre:", opciones: [{ texto: "El capital de nivel 1 y los recursos propios.", esCorrecta: false }, { texto: "Recursos propios y el valor de exposición de total activo contable.", esCorrecta: false }, { texto: "Recursos propios y el valor de exposición de los activos ponderados en riesgo.", esCorrecta: false }, { texto: "El capital de nivel 1 y el valor de exposición del total activo contable más las cuentas de orden (avales, límites de crédito, etc.)", esCorrecta: true }] },
                { id: "w_t1_p20", tema: 1, origen: "Wenceslao", texto: "Se denomina riesgo asociado a las participaciones accionariales (empresas participadas por la matriz, en un grupo bancario):", opciones: [{ texto: "A la posible minoración de la solvencia de la entidad, por la excesiva participación en el capital de sus empresas participadas.", esCorrecta: false }, { texto: "A la posibilidad de que la Comisión Nacional del Mercado de Valores, deniegue la participación en el capital de una determinada compañía, para evitar ciertas prácticas monopolísticas.", esCorrecta: false }, { texto: "A la imposibilidad de desprenderse (vender) determinadas participaciones accionariales en empresas del grupo.", esCorrecta: false }, { texto: "A la posible minoración de la solvencia de la entidad, consecuencia de movimientos adversos del mercado, ventas o insolvencia de las participadas.", esCorrecta: true }] },

                // Test Minaya - Tema 1 (Ejemplo, se continuarían extrayendo)
                { id: "m_t1_p1", tema: 1, origen: "Minaya", texto: "La creación de valor de una operación o cliente se define como:", opciones: [{ texto: "El exceso de garantías sobre el nominal de la operación.", esCorrecta: false }, { texto: "El margen que se obtiene una vez descontada la pérdida esperada.", esCorrecta: false }, { texto: "El potencial comercial que tiene el cliente para nuevas operaciones.", esCorrecta: false }, { texto: "El margen que se obtiene una vez retribuido el coste de capital empleado.", esCorrecta: true }] },
                { id: "m_t1_p6", tema: 1, origen: "Minaya", texto: "Hay un golpe de estado en la Republica de Burundi, y el actual gobierno se niega a pagar el crédito que habíamos concedido al gobierno anterior para la financiación de la red local de autobuses. Es un riesgo:", opciones: [{ texto: "País (riesgo de transferencia).", esCorrecta: false }, { texto: "País (riesgo soberano).", esCorrecta: true }, { texto: "Liquidez.", esCorrecta: false }, { texto: "Mercado de negociación.", esCorrecta: false }] },
                { id: "m_t1_p19", tema: 1, origen: "Minaya", texto: "La cultura de riesgos:", opciones: [{ texto: "Comprende una serie de actitudes, valores, habilidades y pautas de actuación frente a los riesgos.", esCorrecta: true }, { texto: "Es el conjunto de normas sobre riesgos, establecidas por el Banco de España.", esCorrecta: false }, { texto: "Corresponde a la aplicación exhaustiva de las normas internas y recomendaciones de la auditoria, en el ámbito de riesgos.", esCorrecta: false }, { texto: "Supone la aplicación de los acuerdos alcanzados por la Asociación Española de Banca, que son vinculantes para la entidad.", esCorrecta: false }] },

                // Test Miguel - Tema 1
                { id: "mig_t1_p1", tema: 1, origen: "Miguel", texto: "La cultura de riesgos:", opciones: [{ texto: "Corresponde a la aplicación exhaustiva de las normas internas y recomendaciones de la auditoria, en el ámbito de riesgos.", esCorrecta: false }, { texto: "Comprende una serie de actitudes, valores, habilidades y pautas de actuación frente a los riesgos.", esCorrecta: true }, { texto: "Es el conjunto de normas sobre riesgos, establecidas por el Banco de España.", esCorrecta: false }, { texto: "Supone la aplicación de los acuerdos alcanzados por la Asociación Española de Banca, que son vinculantes para la entidad.", esCorrecta: false }] },
                { id: "mig_t1_p9", tema: 1, origen: "Miguel", texto: "El modelo estándar basado en porcentajes según el tipo de «cartera de negociación» es una opción válida en el marco de Basilea II para calcular:", opciones: [{ texto: "El riesgo de liquidez.", esCorrecta: false }, { texto: "El riesgo de mercado.", esCorrecta: true }, { texto: "El riesgo de modelo.", esCorrecta: false }, { texto: "El riesgo reputacional.", esCorrecta: false }] },

                // Test Luci - Tema 1
                { id: "lu_t1_p1", tema: 1, origen: "Luci", texto: "La probabilidad de que un cliente no atienda sus obligaciones contractuales durante un periodo superior a 90 días se define como:", opciones: [{ texto: "Pérdida esperada (PE).", esCorrecta: false }, { texto: "Severidad (LGD).", esCorrecta: false }, { texto: "Exposición (EAD).", esCorrecta: false }, { texto: "Probabilidad de incumplimiento (PD).", esCorrecta: true }] },
                { id: "lu_t1_p8", tema: 1, origen: "Luci", texto: "La ratio que propone que las entidades cubran sus necesidades permanentes de liquidez derivadas de la actividad comercial a través de una adecuada financiación, mediante instrumentos de medio y largo plazo, y de una limitada apelación al corto plazo, así como un mayor peso de los depósitos de clientes, se denomina:", opciones: [{ texto: "LtV (‘loan to value’).", esCorrecta: false }, { texto: "NSFR (‘net stable funding ratio’).", esCorrecta: true }, { texto: "LRC (‘liquidity coverage ratio’).", esCorrecta: false }, { texto: "LtD (‘loan to deposit’).", esCorrecta: false }] },
                
                // Test Jenny - Tema 2 (Ejemplo)
                { id: "j_t2_p1", tema: 2, origen: "Jenny", texto: "El Registro de Aceptaciones Impagadas (RAI) recoge impagados por documento de giro con fuerza ejecutiva en los que consta la firma del deudor reconociendo la deuda, de importe superior a:", opciones: [{ texto: "200 euros", esCorrecta: false }, { texto: "400 euros", esCorrecta: false }, { texto: "300 euros", esCorrecta: true }, { texto: "100 euros", esCorrecta: false }] },
                { id: "j_t2_p4", tema: 2, origen: "Jenny", texto: "Cuando el fiador se coloca en la misma posición que el deudor principal, renunciando así a una serie de derechos que le concede la ley, ¿se trata de un afianzamiento…?", opciones: [{ texto: "Declarativo", esCorrecta: false }, { texto: "Subsidiario", esCorrecta: false }, { texto: "De segundo orden", esCorrecta: false }, { texto: "Solidario", esCorrecta: true }] },

                // Test Guaci - Tema 3 (Ejemplo)
                { id: "g_t3_p1", tema: 3, origen: "Guaci", texto: "El activo corriente, corresponde a:", opciones: [{ texto: "Comprenden en general todas las inversiones realizadas por la empresa.", esCorrecta: false }, { texto: "Son aquellos activos de baja calidad.", esCorrecta: false }, { texto: "Todas las inversiones realizadas que duran menos de un año.", esCorrecta: true }, { texto: "Todas las inversiones realizadas que duran más de un año.", esCorrecta: false }] },
                { id: "g_t3_p17", tema: 3, origen: "Guaci", texto: "Un balance debe:", opciones: [{ texto: "Ser fiel a los intereses de los accionistas.", esCorrecta: false }, { texto: "Ser equilibrado.", esCorrecta: false }, { texto: "Reflejar la imagen fiel de la empresa.", esCorrecta: true }, { texto: "Reflejar la realidad de mercado.", esCorrecta: false }] },

                // Test Alfonso - Tema 4 (Ejemplo)
                { id: "a_t4_p1", tema: 4, origen: "Alfonso", texto: "Un modelo de negocio empresarial debe responder a las siguientes preguntas:", opciones: [{ texto: "Cliente, diferenciación, calidad.", esCorrecta: false }, { texto: "Mercado, producto/servicio, procesos internos.", esCorrecta: true }, { texto: "Mercado, atributos del producto, tiempo de respuesta.", esCorrecta: false }, { texto: "Factores clave, diferenciación, procesos internos.", esCorrecta: false }] },
                { id: "a_t4_p6", tema: 4, origen: "Alfonso", texto: "Cuando se habla de ciclicidad de una empresa, en relación al sector en el que ésta actúa, nos referimos:", opciones: [{ texto: "A la rotación de existencias en relación a la media del sector.", esCorrecta: false }, { texto: "A las rotaciones de su activo en relación a la media del sector.", esCorrecta: false }, { texto: "Al incremento o disminución de la actividad de forma continuada a lo largo de diversos ejercicios.", esCorrecta: true }, { texto: "A la necesidad relativa de financiación de circulante en relación a la media del sector.", esCorrecta: false }] },

                // Test Alberto - Tema 5 (Ejemplo)
                { id: "alb_t5_p1", tema: 5, origen: "Alberto", texto: "En una operación de comercio internacional, el importador es:", opciones: [{ texto: "Quien tiene el papel de notificador y confirmador en el crédito documentario.", esCorrecta: false }, { texto: "Quien resulta beneficiario del crédito documentario, cuya apertura ha sido ordenada por el exportador.", esCorrecta: false }, { texto: "Quien ordena la apertura del crédito documentario, jamás el exportador.", esCorrecta: true }, { texto: "Quien corre con el esfuerzo financiero y el riesgo de la financiación al exportador.", esCorrecta: false }] },
                { id: "alb_t5_p11", tema: 5, origen: "Alberto", texto: "La cláusula ‘salvo buen fin’ en una letra de cambio:", opciones: [{ texto: "Implica que la entidad de crédito se hace cargo del impagado, al tratarse de una cesión de crédito ‘sin recurso’.", esCorrecta: false }, { texto: "Permite a la entidad de crédito reclamar el importe anticipado al cedente en caso de que el efecto cedido (cesión de crédito) resulte impagado por el deudor.", esCorrecta: true }, { texto: "Impide a la entidad de crédito reclamar el importe anticipado al cedente en caso de que el efecto cedido (cesión de crédito) resulte impagado por el deudor.", esCorrecta: false }, { texto: "La cláusula ‘salvo buen fin’ no puede figurar en una letra de cambio, ya que se trata de una cláusula aplicable a los contratos de ‘factoring’ con anticipo de facturas.", esCorrecta: false }] },

                // Test Eva - Tema 6 (Ejemplo)
                 { id: "eva_t6_p2", tema: 6, origen: "Eva", texto: "Al denominado Emprendedor de Responsabilidad limitada:", opciones: [{ texto: "En determinadas circunstancias, se le puede excluir su vivienda habitual de la responsabilidad por las deudas derivadas de su actividad empresarial.", esCorrecta: true }, { texto: "Se le puede excluir cualquier vivienda de la responsabilidad por todas las deudas asumidas con las entidades financieras.", esCorrecta: false }, { texto: "Siempre se le puede excluir su vivienda habitual de la responsabilidad por las deudas derivadas de su actividad empresarial.", esCorrecta: false }, { texto: "Se le puede excluir la segunda residencia de la responsabilidad derivada de sus deudas empresariales.", esCorrecta: false }] },
                 { id: "eva_t6_p11", tema: 6, origen: "Eva", texto: "Cuando decimos que el cálculo del scoring lo realizamos sobre la base de datos de la operativa interna y de la vinculación del cliente, nos referimos al scoring:", opciones: [{ texto: "De Evaluación.", esCorrecta: false }, { texto: "Psicométrico.", esCorrecta: false }, { texto: "Reactivo de Admisión.", esCorrecta: false }, { texto: "De Comportamiento.", esCorrecta: true }] },

                // --- FIN DE PREGUNTAS EXTRAÍDAS (EJEMPLO PARCIAL) ---
                // Se necesitaría un proceso más exhaustivo para extraer todas las preguntas de todos los temas de los 9 documentos.
                // Por ahora, añadiré algunas preguntas generadas adicionales para asegurar que todos los temas tengan contenido para la demo.
            ];

            // Lógica para asegurar que haya al menos unas pocas preguntas por tema si la extracción fue limitada
            const preguntasPorTemaBase = {};
            preguntasGlobal.forEach(p => {
                if (!preguntasPorTemaBase[p.tema]) preguntasPorTemaBase[p.tema] = [];
                preguntasPorTemaBase[p.tema].push(p);
            });

            for (let i = 1; i <= 10; i++) { // Para 10 temas
                let existentes = preguntasPorTemaBase[i] ? preguntasPorTemaBase[i].length : 0;
                if (existentes < 5) { // Si hay menos de 5 preguntas extraídas para un tema, añadir algunas genéricas
                    for (let j = existentes + 1; j <= 5; j++) { 
                        preguntasGlobal.push({
                            id: `t${i}_p${j}_gen_extra`,
                            tema: i,
                            origen: "Generada (Complemento)",
                            texto: `Pregunta adicional ${j} para el Tema ${i}: Considerando el concepto clave ${String.fromCharCode(64 + j)} del tema ${i}, ¿cuál sería su principal impacto en la evaluación de riesgos?`,
                            opciones: [
                                { texto: `Impacto A (Tema ${i})`, esCorrecta: j % 4 === 0 },
                                { texto: `Impacto B (Tema ${i})`, esCorrecta: j % 4 === 1 },
                                { texto: `Impacto C (Tema ${i})`, esCorrecta: j % 4 === 2 },
                                { texto: `Impacto D (Tema ${i})`, esCorrecta: j % 4 === 3 }
                            ]
                        });
                    }
                }
            }
        }
        
        let estadoActual = {
            vista: 'inicio', 
            modo: null, 
            temaActual: null, 
            examenActualId: null, 
            preguntasCuestionario: [],
            preguntaActualIdx: 0,
            respuestasUsuario: [],
            puntuacion: 0,
            progresoGuardado: null 
        };

        const appContainer = document.getElementById('app');

        function getItem(key) {
            try {
                const item = localStorage.getItem(`${appId}_${key}`);
                return item ? JSON.parse(item) : null;
            } catch (e) {
                console.error("Error al leer de localStorage:", key, e);
                return null;
            }
        }

        function setItem(key, value) {
            try {
                localStorage.setItem(`${appId}_${key}`, JSON.stringify(value));
            } catch (e) {
                console.error("Error al escribir en localStorage:", key, e);
                mostrarMensaje("Error al guardar progreso. Es posible que el almacenamiento esté lleno.", "error");
            }
        }

        function removeItem(key) {
            localStorage.removeItem(`${appId}_${key}`);
        }

        function renderizarVista() {
            appContainer.innerHTML = ''; 
            switch (estadoActual.vista) {
                case 'inicio':
                    renderizarInicio();
                    break;
                case 'seleccionTema':
                    renderizarSeleccionTema();
                    break;
                case 'cuestionario':
                    renderizarCuestionario();
                    break;
                case 'resultados':
                    renderizarResultados();
                    break;
                default:
                    renderizarInicio();
            }
        }

        function crearBoton(texto, onClick, clasesAdicionales = '') {
            const boton = document.createElement('button');
            boton.textContent = texto;
            boton.className = `bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out ${clasesAdicionales}`;
            boton.onclick = onClick;
            return boton;
        }
        
        function crearContenedorModal(titulo) {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'modalOverlay';
            modalOverlay.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4';
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all scale-95 opacity-0 animate-modal-appear';
            modalContent.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">${titulo}</h2>`;
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 50);
            return modalContent;
        }

        function cerrarModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                const modalContent = modalOverlay.querySelector('div > div'); 
                 if (modalContent) {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                setTimeout(() => modalOverlay.remove(), 300); 
            }
        }

        async function verificarProgresoPrevio() {
            let progresoTemaMasReciente = null;
            for (let i = 1; i <= 10; i++) { 
                const progreso = getItem(`topicProgress_${i}`);
                if (progreso && (!progresoTemaMasReciente || new Date(progreso.lastAccessed) > new Date(progresoTemaMasReciente.lastAccessed))) {
                    progresoTemaMasReciente = {...progreso, id: String(i), tipo: 'tema'};
                }
            }
            let progresoExamenMasReciente = null;
            const examKeys = Object.keys(localStorage).filter(k => k.startsWith(`${appId}_examProgress_`));
            examKeys.forEach(key => {
                const progreso = getItem(key.substring(appId.length + 1)); 
                if (progreso && (!progresoExamenMasReciente || new Date(progreso.lastAccessed) > new Date(progresoExamenMasReciente.lastAccessed))) {
                    progresoExamenMasReciente = {...progreso, id: key.substring(appId.length + 1 + "examProgress_".length), tipo: 'examen'};
                }
            });
            
            let progresoParaContinuar = null;
            if (progresoTemaMasReciente && progresoExamenMasReciente) {
                progresoParaContinuar = new Date(progresoTemaMasReciente.lastAccessed) > new Date(progresoExamenMasReciente.lastAccessed) ? progresoTemaMasReciente : progresoExamenMasReciente;
            } else {
                progresoParaContinuar = progresoTemaMasReciente || progresoExamenMasReciente;
            }

            if (progresoParaContinuar && progresoParaContinuar.currentQuestionIndex > 0 && !progresoParaContinuar.completed) {
                estadoActual.progresoGuardado = progresoParaContinuar;
                mostrarModalContinuar();
            } else {
                renderizarVista(); 
            }
        }

        function mostrarModalContinuar() {
            const modalContent = crearContenedorModal("Continuar Sesión");
            const texto = document.createElement('p');
            texto.className = 'text-gray-700 mb-6 text-center';
            const nombreTemaGuardado = (estadoActual.progresoGuardado.tipo === 'tema' && TEMAS_NOMBRES[estadoActual.progresoGuardado.temaId - 1]) 
                ? TEMAS_NOMBRES[estadoActual.progresoGuardado.temaId - 1] 
                : `examen`;
            const tipo = estadoActual.progresoGuardado.tipo === 'tema' ? `el tema "${nombreTemaGuardado}"` : "un examen final";

            texto.textContent = `Hemos detectado un progreso guardado en ${tipo}. ¿Deseas continuar?`;
            modalContent.appendChild(texto);

            const btnContinuar = crearBoton('Sí, continuar', () => {
                continuarCuestionario();
                cerrarModal();
            }, 'bg-green-500 hover:bg-green-600 mr-2');
            
            const btnNuevo = crearBoton('No, empezar de nuevo', async () => {
                const idProgreso = estadoActual.progresoGuardado.tipo === 'tema' ? estadoActual.progresoGuardado.temaId : estadoActual.progresoGuardado.id;
                await limpiarProgreso(estadoActual.progresoGuardado.tipo, idProgreso);
                estadoActual.progresoGuardado = null;
                cerrarModal();
                renderizarVista(); 
            }, 'bg-red-500 hover:bg-red-600 ml-2');

            const divBotones = document.createElement('div');
            divBotones.className = 'flex justify-center mt-4';
            divBotones.appendChild(btnContinuar);
            divBotones.appendChild(btnNuevo);
            modalContent.appendChild(divBotones);
        }
        
        async function limpiarProgreso(tipo, id) {
            const key = tipo === 'tema' ? `topicProgress_${id}` : `examProgress_${id}`;
            removeItem(key);
            console.log(`Progreso de ${tipo} con ID ${id} eliminado.`);
        }

        function continuarCuestionario() {
            const progreso = estadoActual.progresoGuardado;
            estadoActual.modo = progreso.tipo;
            if (progreso.tipo === 'tema') {
                estadoActual.temaActual = progreso.temaId;
                estadoActual.preguntasCuestionario = shuffleArray([...preguntasGlobal.filter(p => p.tema === estadoActual.temaActual)]);
            } else { 
                estadoActual.examenActualId = progreso.id || progreso.examId; 
                if (progreso.questionsInExam && progreso.questionsInExam.length > 0) {
                    estadoActual.preguntasCuestionario = progreso.questionsInExam.map(qId => preguntasGlobal.find(p => p.id === qId)).filter(p => p);
                } else {
                    iniciarExamenFinal(true); 
                    return;
                }
            }
            estadoActual.preguntaActualIdx = progreso.currentQuestionIndex || 0;
            estadoActual.respuestasUsuario = progreso.userAnswers || [];
            estadoActual.puntuacion = progreso.score || 0;
            estadoActual.vista = 'cuestionario';
            renderizarVista();
        }

        function renderizarInicio() {
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6 font-inter">
                    <div class="bg-slate-800 p-8 sm:p-12 rounded-xl shadow-2xl text-center max-w-2xl w-full transform transition-all hover:scale-105 duration-300">
                        <h1 class="text-4xl sm:text-5xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Plataforma de Estudio Interactivo</h1>
                        <p class="text-slate-300 mb-10 text-lg">Prepárate para tus exámenes de Riesgos Bancarios. Elige una opción para comenzar:</p>
                        <div id="botonesInicioContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                         <div id="botonBorrarDatosContainer" class="mt-10"></div>
                    </div>
                </div>
            `;

            const botonesContainer = document.getElementById('botonesInicioContainer');
            if (botonesContainer) {
                const btnRepasarTema = crearBoton('Repasar por Tema', () => { estadoActual.vista = 'seleccionTema'; renderizarVista(); }, 'w-full text-lg');
                const btnExamenFinal = crearBoton('Hacer Examen Final', () => iniciarExamenFinal(false), 'w-full text-lg');
                const btnRevisarFallos = crearBoton('Revisar Preguntas Falladas', iniciarRevisionFallos, 'w-full text-lg md:col-span-2'); // Ocupa 2 columnas en md
                
                botonesContainer.appendChild(btnRepasarTema);
                botonesContainer.appendChild(btnExamenFinal);
                botonesContainer.appendChild(btnRevisarFallos);

            } else {
                console.error("El contenedor de botones 'botonesInicioContainer' no se encontró.");
            }

            const botonBorrarDatosContainer = document.getElementById('botonBorrarDatosContainer');
            if (botonBorrarDatosContainer) {
                const btnBorrarDatos = crearBoton('Borrar Todos los Datos Guardados', mostrarModalBorrarDatos, 'w-full sm:w-auto bg-red-700 hover:bg-red-800 text-sm');
                botonBorrarDatosContainer.appendChild(btnBorrarDatos);
            }
        }

        function mostrarModalBorrarDatos() {
            const modalContent = crearContenedorModal("Confirmar Borrado de Datos");
            const texto = document.createElement('p');
            texto.className = 'text-gray-700 mb-6 text-center';
            texto.textContent = "¿Estás seguro de que quieres borrar todos los datos guardados (progreso, exámenes, fallos)? Esta acción no se puede deshacer.";
            modalContent.appendChild(texto);

            const btnConfirmar = crearBoton('Sí, borrar todo', () => {
                borrarTodosLosDatos();
                cerrarModal();
                mostrarMensaje("Todos los datos guardados han sido borrados.", "success");
            }, 'bg-red-600 hover:bg-red-700 mr-2');
            
            const btnCancelar = crearBoton('Cancelar', cerrarModal, 'bg-gray-300 hover:bg-gray-400 text-gray-800 ml-2');

            const divBotones = document.createElement('div');
            divBotones.className = 'flex justify-center mt-4';
            divBotones.appendChild(btnConfirmar);
            divBotones.appendChild(btnCancelar);
            modalContent.appendChild(divBotones);
        }

        function borrarTodosLosDatos() {
            for (let i = 0; i < localStorage.length; i++){
                const key = localStorage.key(i);
                if (key && key.startsWith(appId + "_")) { // Solo borrar claves de esta app
                    localStorage.removeItem(key);
                    i--; // Ajustar índice ya que la longitud de localStorage cambia
                }
            }
            // Resetear estado actual
            estadoActual = {
                vista: 'inicio',
                modo: null,
                temaActual: null,
                examenActualId: null,
                preguntasCuestionario: [],
                preguntaActualIdx: 0,
                respuestasUsuario: [],
                puntuacion: 0,
                progresoGuardado: null
            };
            console.log("Todos los datos de localStorage para esta app borrados.");
            renderizarVista(); // Volver al inicio
        }


        function renderizarSeleccionTema() {
            const temasUnicos = [...new Set(preguntasGlobal.map(p => p.tema))].sort((a,b) => a-b);
            appContainer.innerHTML = `
                <div class="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 font-inter text-white">
                    <div class="bg-slate-800 p-8 sm:p-10 rounded-xl shadow-xl max-w-lg w-full">
                        <h2 class="text-3xl font-bold mb-8 text-center text-sky-400">Selecciona un Tema para Repasar</h2>
                        <div id="botonesTemaContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"></div>
                        <div id="botonVolverContainer"></div>
                    </div>
                </div>
            `;
            const botonesTemaContainer = document.getElementById('botonesTemaContainer');
            if (botonesTemaContainer) {
                temasUnicos.forEach(numTema => {
                    const nombreTema = TEMAS_NOMBRES[numTema - 1] || `Tema ${numTema}`;
                    const botonTema = crearBoton(nombreTema, () => iniciarCuestionarioTema(numTema, false), 'w-full bg-sky-600 hover:bg-sky-700');
                    botonesTemaContainer.appendChild(botonTema);
                });
            }
            const botonVolverContainer = document.getElementById('botonVolverContainer');
            if (botonVolverContainer) {
                 const botonVolver = crearBoton('Volver al Inicio', () => { estadoActual.vista = 'inicio'; renderizarVista(); }, 'w-full mt-4 bg-slate-600 hover:bg-slate-700');
                 botonVolverContainer.appendChild(botonVolver);
            }
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        async function iniciarCuestionarioTema(numTema, omitirVerificacionProgreso = false) {
            estadoActual.modo = 'tema';
            estadoActual.temaActual = numTema;
            if (!omitirVerificacionProgreso) {
                const progresoGuardado = getItem(`topicProgress_${numTema}`);
                if (progresoGuardado && progresoGuardado.currentQuestionIndex > 0 && !progresoGuardado.completed) {
                    estadoActual.progresoGuardado = { ...progresoGuardado, temaId: numTema, tipo: 'tema', id: String(numTema) };
                    mostrarModalContinuar();
                    return; 
                }
            }
            estadoActual.preguntasCuestionario = shuffleArray([...preguntasGlobal.filter(p => p.tema === numTema)]);
            estadoActual.preguntaActualIdx = 0;
            estadoActual.respuestasUsuario = [];
            estadoActual.puntuacion = 0;
            estadoActual.vista = 'cuestionario';
            renderizarVista();
        }

        async function iniciarExamenFinal(omitirVerificacionProgreso = false) {
            estadoActual.modo = 'examen';
            if (!omitirVerificacionProgreso) {
                const examKeys = Object.keys(localStorage).filter(k => k.startsWith(`${appId}_examProgress_`));
                let examenEnCurso = null;
                for (const key of examKeys) {
                    const progreso = getItem(key.substring(appId.length + 1));
                    if (progreso && !progreso.completed && progreso.currentQuestionIndex > 0) {
                         if (!examenEnCurso || new Date(progreso.lastAccessed) > new Date(examenEnCurso.lastAccessed)) {
                            examenEnCurso = {...progreso, id: key.substring(appId.length + 1 + "examProgress_".length), tipo: 'examen'};
                        }
                    }
                }
                if (examenEnCurso) {
                    estadoActual.progresoGuardado = examenEnCurso;
                    mostrarModalContinuar();
                    return;
                }
            }
            let preguntasExamen = [];
            const preguntasPorTema = {};
            preguntasGlobal.forEach(p => {
                if (!preguntasPorTema[p.tema]) preguntasPorTema[p.tema] = [];
                preguntasPorTema[p.tema].push(p);
            });
            for (let i = 1; i <= 10; i++) { 
                if (preguntasPorTema[i]) {
                    const temaPreguntas = shuffleArray([...preguntasPorTema[i]]);
                    preguntasExamen.push(...temaPreguntas.slice(0, 10)); 
                }
            }
            estadoActual.preguntasCuestionario = shuffleArray(preguntasExamen.slice(0,100)); 
            estadoActual.preguntaActualIdx = 0;
            estadoActual.respuestasUsuario = [];
            estadoActual.puntuacion = 0;
            estadoActual.examenActualId = `examen_${Date.now()}`; 
            estadoActual.vista = 'cuestionario';
            renderizarVista();
        }
        
        async function iniciarRevisionFallos() {
            const idsFalladas = getItem('failedQuestions') || [];
            const preguntasFalladasCargadas = preguntasGlobal.filter(p => idsFalladas.includes(p.id));
            if (preguntasFalladasCargadas.length === 0) {
                mostrarMensaje("¡Felicidades! No tienes preguntas falladas para revisar.", "info");
                estadoActual.vista = 'inicio';
                renderizarVista();
                return;
            }
            estadoActual.preguntasCuestionario = shuffleArray(preguntasFalladasCargadas); // No mapear aquí para añadir respuestaCorrectaTexto
            estadoActual.modo = 'revision';
            estadoActual.preguntaActualIdx = 0;
            estadoActual.respuestasUsuario = []; 
            estadoActual.puntuacion = 0;
            estadoActual.vista = 'cuestionario'; 
            renderizarVista();
        }

        function renderizarCuestionario() {
            if (estadoActual.preguntasCuestionario.length === 0) {
                 const mensaje = estadoActual.modo === 'revision' ? "No hay preguntas falladas para revisar." : `No hay preguntas disponibles para este ${estadoActual.modo}.`;
                 const titulo = estadoActual.modo === 'revision' ? "Cuestionario de Preguntas Falladas" : (estadoActual.modo === 'tema' ? TEMAS_NOMBRES[estadoActual.temaActual - 1] : 'Examen Final');
                appContainer.innerHTML = `
                <div class="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white font-inter">
                    <div class="bg-slate-800 p-8 sm:p-10 rounded-xl shadow-xl text-center">
                        <h2 class="text-2xl font-bold mb-6">${titulo}</h2>
                        <p class="mb-6">${mensaje}</p>
                    </div>
                </div>`;
                const btnVolver = crearBoton('Volver al Inicio', () => { estadoActual.vista = 'inicio'; renderizarVista(); }, 'w-full mt-4');
                appContainer.querySelector('.bg-slate-800').appendChild(btnVolver);
                return;
            }

            const pregunta = estadoActual.preguntasCuestionario[estadoActual.preguntaActualIdx];
            const opcionesOriginales = pregunta.opciones;
            const opcionesBarajadas = shuffleArray([...pregunta.opciones]); 

            const tituloCuestionario = estadoActual.modo === 'revision' 
                ? 'Cuestionario de Preguntas Falladas' 
                : (estadoActual.modo === 'revision_especifica' // Nuevo modo para la revisión post-quiz
                    ? 'Revisión del Cuestionario Actual'
                    : (estadoActual.modo === 'tema' ? TEMAS_NOMBRES[estadoActual.temaActual - 1] : 'Examen Final'));

            appContainer.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-4 sm:p-6 font-inter">
                    <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl sm:text-2xl font-semibold text-blue-400">${tituloCuestionario}</h2>
                            <span class="text-sm text-slate-400">Pregunta ${estadoActual.preguntaActualIdx + 1} de ${estadoActual.preguntasCuestionario.length}</span>
                        </div>
                        <div class="bg-slate-700 p-5 rounded-lg mb-6 min-h-[60px]">
                            <p class="text-lg sm:text-xl leading-relaxed">${pregunta.texto}</p>
                        </div>
                        <div id="opcionesCuestionarioContainer" class="mb-8"></div>
                        <div id="botonesCuestionarioContainer" class="flex flex-col sm:flex-row justify-between items-center gap-3"></div>
                        <div id="respuestaCorrectaContainer" class="mt-4"></div>
                    </div>
                </div>
            `;

            const opcionesContainer = document.getElementById('opcionesCuestionarioContainer');
            opcionesBarajadas.forEach((op) => {
                const indiceOriginal = opcionesOriginales.findIndex(o => o.texto === op.texto);
                const label = document.createElement('label');
                label.className = "block bg-slate-700 hover:bg-slate-600 p-4 rounded-lg cursor-pointer transition duration-150 mb-3 has-[:checked]:bg-blue-500 has-[:checked]:ring-2 has-[:checked]:ring-blue-300";
                const input = document.createElement('input');
                input.type = "radio";
                input.name = "opcion";
                input.value = indiceOriginal;
                input.className = "sr-only peer";
                if (estadoActual.modo === 'revision_especifica') input.disabled = true; // Deshabilitar radios en revisión específica
                const span = document.createElement('span');
                span.className = "text-slate-200 peer-checked:text-white";
                span.textContent = op.texto;
                label.appendChild(input);
                label.appendChild(span);
                opcionesContainer.appendChild(label);
            });
            
            const botonesCuestionarioContainer = document.getElementById('botonesCuestionarioContainer');
            const btnSiguiente = crearBoton(
                (estadoActual.modo === 'revision' || estadoActual.modo === 'revision_especifica') ? 'Siguiente Pregunta' : 'Saltar / Siguiente', 
                manejarSiguientePregunta, 
                'w-full sm:w-auto'
            );
            botonesCuestionarioContainer.appendChild(btnSiguiente);

            const btnTerminar = crearBoton(
                (estadoActual.modo === 'revision' || estadoActual.modo === 'revision_especifica') ? 'Terminar Revisión' : 'Terminar Cuestionario', 
                () => { estadoActual.vista = (estadoActual.modo === 'revision' || estadoActual.modo === 'revision_especifica') ? 'resultados' : 'resultados'; renderizarResultados(); }, 
                'w-full sm:w-auto bg-red-600 hover:bg-red-700'
            );
            if (estadoActual.modo === 'revision_especifica' && estadoActual.preguntaActualIdx >= estadoActual.preguntasCuestionario.length -1) {
                 // No mostrar "terminar" si es la última pregunta en revisión específica, solo "siguiente" que llevará a resultados
            } else {
                botonesCuestionarioContainer.appendChild(btnTerminar);
            }


            const respuestaCorrectaContainer = document.getElementById('respuestaCorrectaContainer');
            if (estadoActual.modo === 'revision_especifica' && pregunta.respuestaCorrectaTexto) {
                respuestaCorrectaContainer.innerHTML = `<div class="p-3 bg-green-800 border border-green-600 rounded-lg text-sm text-green-200"><strong>Respuesta Correcta:</strong> ${pregunta.respuestaCorrectaTexto}</div>`;
            } else {
                respuestaCorrectaContainer.innerHTML = '';
            }
            
            const respuestaGuardada = estadoActual.respuestasUsuario.find(r => r.questionId === pregunta.id);
            if (respuestaGuardada && estadoActual.modo !== 'revision_especifica') { // No pre-seleccionar en revisión específica
                const radioInput = appContainer.querySelector(`input[name="opcion"][value="${respuestaGuardada.selectedOptionIndex}"]`);
                if (radioInput) radioInput.checked = true;
            }
        }
        
        async function manejarSiguientePregunta() {
            const preguntaActual = estadoActual.preguntasCuestionario[estadoActual.preguntaActualIdx];
            const opcionSeleccionadaInput = document.querySelector('input[name="opcion"]:checked');
            
            // Solo procesar respuesta si no estamos en modo 'revision_especifica'
            if (estadoActual.modo !== 'revision_especifica') {
                if (opcionSeleccionadaInput) {
                    const opcionIdxOriginal = parseInt(opcionSeleccionadaInput.value); 
                    const esCorrecta = preguntaActual.opciones[opcionIdxOriginal].esCorrecta;
                    const respuestaExistenteIdx = estadoActual.respuestasUsuario.findIndex(r => r.questionId === preguntaActual.id);
                    if (respuestaExistenteIdx > -1) {
                        estadoActual.respuestasUsuario[respuestaExistenteIdx] = { questionId: preguntaActual.id, selectedOptionIndex: opcionIdxOriginal, isCorrect: esCorrecta };
                    } else {
                        estadoActual.respuestasUsuario.push({ questionId: preguntaActual.id, selectedOptionIndex: opcionIdxOriginal, isCorrect: esCorrecta });
                    }
                    // Actualizar lista global de fallos
                    if (esCorrecta) {
                        await quitarDeFalladas(preguntaActual.id);
                    } else {
                        await anadirAFalladas(preguntaActual);
                    }
                } else { 
                     if (estadoActual.modo !== 'revision') { // Si es un quiz normal y se salta, se considera fallada
                        await anadirAFalladas(preguntaActual); 
                     }
                }
            }

            estadoActual.preguntaActualIdx++;
            // Guardar progreso para modos 'tema' y 'examen'
            if (estadoActual.modo === 'tema' || estadoActual.modo === 'examen') {
                await guardarProgresoLocalStorage(); 
            }
            
            if (estadoActual.preguntaActualIdx < estadoActual.preguntasCuestionario.length) {
                if (estadoActual.modo === 'examen' && estadoActual.preguntaActualIdx % 20 === 0 && estadoActual.preguntaActualIdx > 0) {
                    mostrarEstadisticasParcialesExamen(); 
                } else {
                    renderizarCuestionario();
                }
            } else {
                estadoActual.vista = 'resultados';
                renderizarResultados();
            }
        }
        
        async function guardarProgresoLocalStorage() {
            const ahora = new Date().toISOString();
            let key;
            let progreso;

            if (estadoActual.modo === 'tema') {
                key = `topicProgress_${estadoActual.temaActual}`;
                progreso = {
                    temaId: estadoActual.temaActual,
                    currentQuestionIndex: estadoActual.preguntaActualIdx,
                    userAnswers: estadoActual.respuestasUsuario,
                    score: calcularPuntuacion(),
                    completed: estadoActual.preguntaActualIdx >= estadoActual.preguntasCuestionario.length,
                    lastAccessed: ahora 
                };
            } else if (estadoActual.modo === 'examen') {
                key = `examProgress_${estadoActual.examenActualId}`;
                progreso = {
                    examId: estadoActual.examenActualId,
                    currentQuestionIndex: estadoActual.preguntaActualIdx,
                    userAnswers: estadoActual.respuestasUsuario,
                    score: calcularPuntuacion(),
                    questionsInExam: estadoActual.preguntasCuestionario.map(p => p.id),
                    completed: estadoActual.preguntaActualIdx >= estadoActual.preguntasCuestionario.length,
                    lastAccessed: ahora
                };
            } 
            // No guardamos progreso específico para 'revision' o 'revision_especifica' aquí
            if(key && progreso) setItem(key, progreso);
        }

        function calcularPuntuacion() {
            // Solo calcula puntuación para las respuestas dadas en la sesión actual del cuestionario
            return estadoActual.respuestasUsuario.filter(r => r.isCorrect).length;
        }
        
        function mostrarEstadisticasParcialesExamen() {
            const totalRespondidas = estadoActual.preguntaActualIdx;
            const respondidasEnEsteBloque = estadoActual.respuestasUsuario.slice(Math.max(0, totalRespondidas - 20), totalRespondidas);
            const correctasEnEsteBloque = respondidasEnEsteBloque.filter(r => r.isCorrect).length;
            const numPreguntasBloque = respondidasEnEsteBloque.length; 
            
            const modalContent = crearContenedorModal("Estadísticas Parciales del Examen");
            const texto = document.createElement('p');
            texto.className = 'text-gray-700 mb-4 text-lg text-left';
            texto.innerHTML = `Has completado ${totalRespondidas} de ${estadoActual.preguntasCuestionario.length} preguntas.<br>
                               En las últimas ${numPreguntasBloque} preguntas:<br>
                               Aciertos: ${correctasEnEsteBloque} de ${numPreguntasBloque}.<br>
                               Porcentaje: ${numPreguntasBloque > 0 ? ((correctasEnEsteBloque / numPreguntasBloque) * 100).toFixed(1) : 0}%`;
            modalContent.appendChild(texto);
            const btnContinuar = crearBoton('Continuar Examen', () => {
                cerrarModal();
                renderizarCuestionario(); 
            }, 'w-full mt-4');
            modalContent.appendChild(btnContinuar);
        }

        async function renderizarResultados() {
            const puntuacionFinal = calcularPuntuacion(); // Basado en estadoActual.respuestasUsuario de la sesión actual
            const totalPreguntas = estadoActual.preguntasCuestionario.length;
            const porcentaje = totalPreguntas > 0 ? (puntuacionFinal / totalPreguntas * 100).toFixed(1) : 0;
            
            const ahora = new Date().toISOString();
            let keyToUpdate;
            let dataToUpdate;

            if (estadoActual.modo === 'tema') {
                keyToUpdate = `topicProgress_${estadoActual.temaActual}`;
                dataToUpdate = { 
                    score: puntuacionFinal, 
                    completed: true, 
                    userAnswers: estadoActual.respuestasUsuario, 
                    lastAccessed: ahora,
                    currentQuestionIndex: estadoActual.preguntaActualIdx 
                };
            } else if (estadoActual.modo === 'examen') {
                 keyToUpdate = `examProgress_${estadoActual.examenActualId}`;
                 dataToUpdate = { 
                    score: puntuacionFinal, 
                    completed: true, 
                    userAnswers: estadoActual.respuestasUsuario,
                    lastAccessed: ahora,
                    currentQuestionIndex: estadoActual.preguntaActualIdx 
                };
            } else if (estadoActual.modo === 'revision') {
                // El quiz de revisión ya actualizó la lista global de fallos en manejarSiguientePregunta.
                // Aquí solo mostramos los resultados de *esta sesión de revisión*.
            }


            if (keyToUpdate && dataToUpdate && (estadoActual.modo === 'tema' || estadoActual.modo === 'examen')) {
                const progresoExistente = getItem(keyToUpdate) || {};
                setItem(keyToUpdate, { ...progresoExistente, ...dataToUpdate });
            }
            
            let tituloResultados;
            if (estadoActual.modo === 'revision') {
                tituloResultados = 'Resultados del Cuestionario de Fallos';
            } else if (estadoActual.modo === 'tema') {
                tituloResultados = `Resultados: ${TEMAS_NOMBRES[estadoActual.temaActual - 1]}`;
            } else {
                tituloResultados = 'Resultados del Examen Final';
            }
            
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 text-white flex flex-col items-center justify-center p-6 font-inter">
                    <div class="bg-slate-800 p-8 sm:p-12 rounded-xl shadow-2xl text-center max-w-md w-full">
                        <h2 class="text-3xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">${tituloResultados}</h2>
                        <p class="text-xl mb-2">Tu puntuación en esta sesión: <span class="font-bold text-yellow-400">${puntuacionFinal} / ${totalPreguntas}</span></p>
                        <p class="text-xl mb-8">Porcentaje de aciertos: <span class="font-bold text-yellow-400">${porcentaje}%</span></p>
                        <div id="botonesResultadosContainer" class="space-y-4"></div>
                    </div>
                </div>
            `;

            const botonesResultadosContainer = document.getElementById('botonesResultadosContainer');
            if (botonesResultadosContainer) {
                const btnRevisarFallosSesion = crearBoton('Revisar Fallos de Esta Sesión', mostrarFallosDelCuestionarioActual, 'w-full bg-orange-500 hover:bg-orange-600');
                const btnVolverInicio = crearBoton('Volver al Inicio', () => { estadoActual.vista = 'inicio'; renderizarVista(); }, 'w-full');
                botonesResultadosContainer.appendChild(btnRevisarFallosSesion);
                botonesResultadosContainer.appendChild(btnVolverInicio);
            }
        }
        
        function mostrarFallosDelCuestionarioActual() {
            const falladasEsteCuestionario = estadoActual.respuestasUsuario
                .filter(r => !r.isCorrect)
                .map(r => r.questionId);
            
            // Obtener las preguntas originales del cuestionario actual que se fallaron
            const preguntasParaRevisar = estadoActual.preguntasCuestionario
                .filter(p => falladasEsteCuestionario.includes(p.id))
                .map(p => { // Añadir la respuesta correcta para visualización
                    const opcionCorrecta = p.opciones.find(op => op.esCorrecta);
                    return {...p, respuestaCorrectaTexto: opcionCorrecta ? opcionCorrecta.texto : "No disponible"};
                });

            if (preguntasParaRevisar.length === 0) {
                mostrarMensaje("¡No tuviste errores en este cuestionario!", "info");
                return;
            }
            
            // Usar un nuevo array para no modificar el estado del cuestionario original
            estadoActual.preguntasCuestionarioRevisionEspecifica = preguntasParaRevisar;
            estadoActual.modo = 'revision_especifica'; 
            estadoActual.preguntaActualIdx = 0;
            // No resetear respuestasUsuario aquí, ya que no se califica, solo se muestra
            estadoActual.vista = 'cuestionario';
            renderizarVista();
        }

        async function anadirAFalladas(pregunta) {
            if (!pregunta || !pregunta.id) return;
            let idsFalladas = getItem('failedQuestions') || [];
            if (!idsFalladas.includes(pregunta.id)) {
                idsFalladas.push(pregunta.id);
                setItem('failedQuestions', idsFalladas);
            }
        }

        async function quitarDeFalladas(questionId) {
            if (!questionId) return;
            let idsFalladas = getItem('failedQuestions') || [];
            idsFalladas = idsFalladas.filter(id => id !== questionId);
            setItem('failedQuestions', idsFalladas);
        }
        
        function mostrarMensaje(mensaje, tipo = 'info', duracion = 3000) {
            const mensajeDiv = document.createElement('div');
            mensajeDiv.textContent = mensaje;
            let bgColorClass = 'bg-blue-500';
            if (tipo === 'error') bgColorClass = 'bg-red-600';
            if (tipo === 'success') bgColorClass = 'bg-green-600';
            mensajeDiv.className = `fixed bottom-5 right-5 ${bgColorClass} text-white py-3 px-5 rounded-lg shadow-xl text-sm z-50 transform transition-all animate-toast-in`;
            document.body.appendChild(mensajeDiv);
            setTimeout(() => {
                mensajeDiv.classList.remove('animate-toast-in');
                mensajeDiv.classList.add('animate-toast-out');
                setTimeout(() => mensajeDiv.remove(), 500);
            }, duracion);
        }

        async function inicializarApp() {
            await cargarPreguntas(); 
            await verificarProgresoPrevio(); 
        }
        
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes modal-appear {
                from { transform: scale(0.95); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            .animate-modal-appear { animation: modal-appear 0.3s ease-out forwards; }
            @keyframes toast-in {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .animate-toast-in { animation: toast-in 0.5s ease-out forwards; }
            @keyframes toast-out {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            .animate-toast-out { animation: toast-out 0.5s ease-in forwards; }
        `;
        document.head.appendChild(styleSheet);

        inicializarApp();

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-900">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center text-white">Cargando aplicación...</div>
    </div>
</body>
</html>
